\documentclass{article}

\usepackage{minted}
\usepackage{url}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan
}

\begin{document}

\title{Creating a Stand-Alone Spark Environment in Windows Subsystem for Linux}
\author{Abraham Vargas}
\maketitle

\newpage
\tableofcontents
\newpage

\section{\emph{Windows Subsystem for Linux}}
\emph{Windows Subsystem for Linux} (\emph{WSL}) allows \emph{Linux} a distribution (distro) to
run concurrently with \emph{Windows 10}. \emph{WSL 2} now includes a \emph{Linux}
kernel and is several times faster than the original \emph{WSL}. This guide assumes that \emph{WSL 2}
is installed and is running the \emph{Ubuntu 18.04} distro. To install \emph{WSL 2}, follow the
\href{https://docs.microsoft.com/en-us/windows/wsl/install-win10}{Windows Subsystem for Linux Installation Guide for Windows 10}.
Make sure to use \emph{Ubuntu 18.04} as the distro.

\section{Java}
\emph{Spark}, \emph{Hadoop}, and \emph{Hive} all require a \emph{Java Runtime Environment}(\emph{JRE}).
\emph{OpenJDK} is a standard package in most \emph{Linux} distributions. Though \emph{OpenJDK 11}
is the latest version, \emph{Spark} and its related components require \emph{OpenJDK 8}.

    \subsection{Install \emph{JRE}}
    To install \emph{OpenJDK 8}, run the following command in a terminal:
    \begin{minted}{bash}
        sudo apt install openjdk-8-jre-headless            
    \end{minted}

    \subsection{Set \emph{JAVA\_HOME}}
    \label{sec:javahome}
    \emph{Spark} and other components will need to know the path of the
    \emph{JRE}. This is accomplished by setting the \emph{JAVA\_HOME}
    system variable.

    \begin{description}
        \item[Open] the \emph{.bashrc} file with any editor (e.g., \emph{vim}, \emph{nano}).
        For example:
        \begin{minted}{bash}
            vim ~/.bashrc
        \end{minted}

        \item[Add] the following line to the \emph{.bashrc} file:
        \begin{minted}{bash}
            export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64                 
        \end{minted}
        
        \item[Reload] shell environment configuration:
        \begin{minted}{bash}
            source ~/.bashrc
        \end{minted}

        \item[Verify] that path was correctly set:
        \begin{minted}{bash}
            echo $JAVA_HOME
        \end{minted}
    \end{description}

\section{\emph{PostgreSQL}}
\emph{Hive} requires a database for its metastore. In terms of open-source options, \emph{Hive} can use
\emph{MySQL}, \emph{PostgreSQL}, and \emph{Derby}. This guide will use \emph{PostgreSQL}.

    \subsection{Install \emph{PostgreSQL}}
    \emph{PostgreSQL 10} is the default version packaged for \emph{Ubuntu 18.04}. Install
    \emph{PostgreSQL 10} with the command:
    \begin{minted}{bash}
        sudo apt install postgresql-10
    \end{minted}

    \subsection{Start database server}
    The \emph{PostgreSQL} will need to be started every time \emph{WSL} is started. Initialize the
    server using the command:
    \begin{minted}{bash}
        sudo service postgresql start
    \end{minted}

    \subsection{Configure \emph{Hive} metastore}
    The \emph{psql} application is used to interact with \emph{PostgreSQL} in a terminal.
    \begin{description}
        \item[Log into] \emph{PostgreSQL} via \emph{psql} with default user \emph{postgres}:
        \begin{minted}{bash}
            sudo -u postgres psql 
        \end{minted}

        \item[Add] new user \emph{hive}
        (for simplicity, the new user will also be given \emph{hive} as the password):
        \begin{minted}{postgres}
            CREATE USER hive WITH PASSWORD 'hive';
        \end{minted}

        \item[Create] new database for \emph{Hive} metastore:
        \begin{minted}{postgres}
            CREATE DATABASE hive_metastore;
        \end{minted}

        \item[Give] ownership of \emph{hive\_metastore} database to user \emph{hive}:
        \begin{minted}{postgres}
            ALTER DATABASE hive_metastore OWNER TO hive;
        \end{minted}

        \item[Exit] \emph{psql} with the command: \mintinline{psql}{\q}
    \end{description}

    \subsection{Install \emph{Java Database Connectivity} Drivers}
    The \emph{Java Database Connectivity} (\emph{JDBC}) drivers allow \emph{Java} to interact with
    databases. As \emph{Hive} runs in \emph{Java}, it requires the \emph{PostgreSQL JDBC} drivers.
    Install the drivers drivers in \emph{Ubuntu} via the following command:
    \begin{minted}{bash}
        sudo apt install libpostgresql-jdbc-java
    \end{minted}

\section{SSH Key}
\emph{Secure Shell} (\emph{SSH}) encrypts communications over insecure networks. To accomplish encryption
\emph{SSH} utilizes public and private keys.

    \subsection{Generate key}
     Generate] an \emph{ssh key} with the following command:
        \begin{minted}{bash}
            ssh-keygen -t rsa
        \end{minted}
    Leave the password blank when prompted, as \emph{Hadoop} will utilize a password-less \emph{ssh}
    login.

    \subsection{Allow \emph{localhost} login}
    \emph{Hadoop} requires the ability to log into the \emph{localhost} (i.e., your local PC) via
    password-less \emph{ssh}. To accomplish this, run the following command:
    \begin{minted}{bash}
        cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    \end{minted}

    \subsection{Restart \emph{ssh} service}
    \label{sec:sshrestart}
    Run the following command to apply new settings:
    \begin{minted}{bash}
        sudo service ssh restart
    \end{minted}
    This command must be re-executed any time the following error message is encountered:
    \begin{minted}{bash}
        ssh: connect to host localhost port 22: Connection refused
    \end{minted}

    \subsection{Verify password-less \emph{ssh} login}
    Ensure that \emph{localhost} can be accessed via \emph{ssh} without a password:
    \begin{minted}{bash}
        ssh localhost
    \end{minted}
    If an error message is returned, restart the \emph{ssh} service (section \ref{sec:sshrestart}).

\section{\emph{Hadoop}}
\emph{Apache Hadoop} is a framework that is used to store and process \emph{big data} in distributed systems.
In this guide, \emph{Hadoop} will be used as a data storage system on a single PC.

    \subsection{Download and extract \emph{Hadoop 3.3.0}}
    This guide will use the latest stable version, \emph{Hadoop 3.3.0}.
    
        \subsubsection{Download \emph{Hadoop}}
        Run the \emph{wget} command in a terminal to download:
        \begin{minted}{bash}
            wget https://apache.osuosl.org/hadoop/common/hadoop-3.3.0/hadoop-3.3.0.tar.gz
        \end{minted}

        \subsubsection{Extract files}
        Run the following command in a terminal to extract the \emph{tar.gz} file:
        \begin{minted}{bash}
            tar -xvzf hadoop-3.3.0.tar.gz
        \end{minted}
        A new directory, \path{hadoop-3.3.0}, should now appear.

        \subsubsection{Copy folder to \emph{/opt}}
        In \emph{Ubuntu}, \path{/opt} is the directory used to store add-on applications. \emph{Hadoop},
        \emph{Hive}, and \emph{Spark} will all be stored in this directory. Run the following command to
        move the extracted \emph{Hive} folder:
        \begin{minted}{bash}
            sudo mv hadoop-3.3.0 /opt
        \end{minted}
    
    \subsection{Set \emph{HADOOP\_HOME}}
    Setting the \emph{HADOOP\_HOME} variable tells the system where \emph{HADOOP} is located.

        \subsubsection{Edit \emph{.bashrc}}
        \label{subsec:hadoophome}
        Open the \emph{~/.bashrc} file and add the following line:
        \begin{minted}{bash}
            export HADOOP_HOME=/opt/hadoop-3.3.0
        \end{minted}

        \subsubsection{Reload configuration}
        Load the new \emph{bash} configuration with the command:
        \begin{minted}{bash}
            source ~/.bashrc
        \end{minted}

        \subsubsection{Verify path}
        Verify that \emph{HADOOP\_HOME} was correctly set:
        \begin{minted}{bash}
            echo $HADOOP_HOME
        \end{minted}
        The path should match that in \ref{subsec:hadoophome}.

    \subsection{Edit configuration files}
    In this section, \emph{Hadoop} will be configured to run in single-node mode (i.e., on a single PC).

        % This section might not be needed if setting JAVA_HOME in .bashrc is enough
        \subsubsection{Edit \emph{hadoop-env.sh}}
        Add the \emph{JAVA\_HOME} variable to the \emph{Hadoop} environment, as in section \ref{sec:javahome}.

        \begin{enumerate}
            \item Open the file \path{/opt/hadoop-3.3.0/etc/hadoop/hadoop-env.sh} with any editor
            
            \item Un-comment line \emph{54} and add the correct path:
            \begin{minted}{bash}
                # The java implementation to use. By default, this environment
                # variable is REQUIRED on ALL platforms except OS X!
                export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
            \end{minted}
        \end{enumerate}

        \subsubsection{Edit \emph{core-site.xml}}
        Edit the file \path{/opt/hadoop-3.3.0/etc/hadoop/core-site.xml} to look like the example below:
        \begin{minted}{xml}
            <configuration>
                <property>
                    <name>fs.defaultFS</name>
                    <value>hdfs://localhost:9000</value>
                </property>
                <property>
                    <name>hadoop.proxyuser.abe.hosts</name>
                    <value>*</value>
                </property>
                <property>
                    <name>hadoop.proxyuser.abe.groups</name>
                    <value>*</value>
                </property>
            </configuration>
        \end{minted}
        Replace \emph{abe} above with your own \emph{WSL} system username.

        \subsubsection{Edit \emph{hdfs-site.xml}}
        Edit the file \path{/opt/hadoop-3.3.0/etc/hadoop/hdfs-site.xml} to look like the example below:
        \begin{minted}{xml}
            <configuration>
                <property>
                    <name>dfs.replication</name>
                    <value>1</value>
                </property>
            </configuration>
        \end{minted}
        
        \subsubsection{Edit \emph{mapred-site.xml}}
        Edit the file \path{/opt/hadoop-3.3.0/etc/hadoop/mapred-site.xml} to look like the example below:
        % Verify that splitting the <value> into two lines works
        \begin{minted}{xml}
            <configuration>
                <property>
                    <name>mapreduce.framework.name</name>
                    <value>yarn</value>
                </property>
                <property>
                    <name>mapreduce.application.classpath</name>
                    <value>
                        $HADOOP_MAPRED_HOME/share/hadoop/mapreduce/*:
                        $HADOOP_MAPRED_HOME/share/hadoop/mapreduce/lib/*
                    </value>
                </property>
            </configuration>
        \end{minted}
        
        \subsubsection{Edit \emph{yarn-site.xml}}
        Edit the file \path{/opt/hadoop-3.3.0/etc/hadoop/yarn-site.xml} to look like the example below:
        % Verify that splitting the <value> into two lines works
        \begin{minted}{xml}
            <configuration>
                <property>
                    <name>yarn.nodemanager.aux-services</name>
                    <value>mapreduce_shuffle</value>
                </property>
                <property>
                    <name>yarn.nodemanager.env-whitelist</name>
                    <value>
                        JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,
                        HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,
                        HADOOP_YARN_HOME,HADOOP_MAPRED_HOME
                    </value>
                </property>
            </configuration>
        \end{minted}

    \subsection{Format \emph{HDFS}}
    Format the \emph{Hadoop Distributed File System} (\emph{HDFS}) with the command:
    \begin{minted}{bash}
        /opt/hadoop-3.3.0/bin/hdfs namenode -format
    \end{minted}
    The \emph{hdfs} command will output several lines of \emph{INFO} messages.

    \subsection{Start \emph{NameNode} and \emph{DataNode} daemons}
    The daemons allow a web interface containing \emph{Hadoop} system stats to run. To start both
    daemons, run the command:
    \begin{minted}{bash}
        /opt/hadoop-3.3.0/sbin/start-dfs.sh
    \end{minted}
    The above command might return a \emph{connection refused} error. If this occurs, restart
    the \emph{ssh} service (see section \ref{sec:sshrestart}).
    
    The web interface should now be accessible via \url{http://localhost:9870/}.

    \subsection{Start \emph{YARN} daemon}
    \emph{YARN} acts as a resource manager in a \emph{Hadoop} system. To start the \emph{YARN} daemon,
    run the command:
    \begin{minted}{bash}
        /opt/hadoop-3.3.0/sbin/start-yarn.sh
    \end{minted}
    A resource manager web interface should now be accessible via \url{http://localhost:8088/}.

\newpage
\begin{thebibliography}{9}
    \bibitem{postgres_metastore}
    Hewlett Packard Enterprise Development LP,
    \textit{Configuring a Remote PostgreSQL Database for the Hive Metastore},
    2020,
    \url{https://docs.datafabric.hpe.com/61/Hive/Config-RemotePostgreSQLForHiveMetastore.html}
    
    \bibitem{hadoop_install}
    Raymond Tang,
    \textit{Install Hadoop 3.2.0 on Windows 10 using Windows Subsystem for Linux (WSL)},
    2018,
    \url{https://kontext.tech/column/hadoop/307/install-hadoop-320-on-windows-10-using-windows-subsystem-for-linux-wsl}

    \bibitem{ubuntu_install}
    Debian Installer Team,
    \textit{Ubuntu Installation Guide},
    2020,
    \url{https://help.ubuntu.com/lts/installation-guide/amd64/index.html}
\end{thebibliography}

\end{document}